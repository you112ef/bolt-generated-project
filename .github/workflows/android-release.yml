name: Build Release APK

on:
  push:
    branches:
      - main
      - cursor/**
  pull_request:
    branches:
      - main
      - cursor/**
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      GRADLE_OPTS: "-Dorg.gradle.logging.stacktrace=all -Dorg.gradle.console=plain -Dorg.gradle.warning.mode=all -Dkotlin.incremental=false"
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ¤– Set up Android SDK
        uses: android-actions/setup-android@v0
        with:
          sdk-platform: '34'
          sdk-build-tools: '34.0.0'

      - name: ðŸ“ Create local.properties
        run: |
          echo "sdk.dir=$ANDROID_HOME" > local.properties
          echo "âœ… Created local.properties with Android SDK path: $ANDROID_HOME"

      - name: âœ… Accept Android SDK Licenses
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

      - name: ðŸ”§ Make Gradle executable
        run: chmod +x ./gradlew

      - name: ðŸ§¹ Clean Project
        run: ./gradlew clean --no-daemon

      - name: ðŸ”¨ Build Release APK
        run: ./gradlew assembleRelease --no-daemon --stacktrace
        env:
          # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)
          ANDROID_KEYSTORE: ${{ secrets.ANDROID_KEYSTORE }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: ðŸ“± Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/app-release.apk
          retention-days: 30

      - name: ðŸ“Š Build Summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Release Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ APK
          if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
            APK_SIZE=$(du -h "app/build/outputs/apk/release/app-release.apk" | cut -f1)
            echo "âœ… **Build Status**: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“± **APK Size**: $APK_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ **APK Name**: app-release.apk" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **APK Location**: app/build/outputs/apk/release/app-release.apk" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” **Signed**: ${{ secrets.ANDROID_KEYSTORE != '' && 'YES' || 'NO' }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Build Status**: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ” **Debug Info**: No APK file found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Repository**: [AIDE Android App](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒŸ **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸƒ **Run Number**: \`${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY